# Решение проблемы гидратации React

## Проблема

Ошибка гидратации происходила из-за атрибута `bis_skin_checked="1"`, который добавляется браузерным расширением (скорее всего, антивирусом Bitdefender или подобным) после рендеринга на сервере, но до гидратации на клиенте.

### Причина
1. На сервере рендерится HTML без атрибута `bis_skin_checked`
2. Браузерное расширение добавляет этот атрибут
3. При гидратации React видит несоответствие между серверным и клиентским HTML

## Решение

### 1. Компонент ExtensionCleanup

Создан специальный компонент `ExtensionCleanup`, который:
- Автоматически удаляет атрибуты браузерных расширений
- Использует MutationObserver для отслеживания изменений DOM
- Очищает атрибуты в реальном времени

### 2. Улучшенный SafeHydration

Компонент `SafeHydration` обновлен для:
- Более эффективной работы с атрибутами расширений
- Использования CSS модулей для стилизации
- Лучшей интеграции с системой очистки

### 3. Обновленный Layout

В `layout.tsx` добавлен скрипт, который:
- Запускает очистку как можно раньше
- Использует requestAnimationFrame для оптимизации
- Очищает атрибуты при загрузке страницы и изменении DOM

### 4. CSS Модули

Созданы CSS модули для:
- Стилизации компонентов очистки
- Анимаций при очистке
- Отладочной информации

## Использование

### Базовое использование

```tsx
import ExtensionCleanup from './components/ExtensionCleanup';

export default function MyComponent() {
  return (
    <ExtensionCleanup>
      {/* Ваш контент */}
    </ExtensionCleanup>
  );
}
```

### С отладкой

```tsx
<ExtensionCleanup debug={true}>
  {/* Ваш контент с отладочной информацией */}
</ExtensionCleanup>
```

### Комбинирование с SafeHydration

```tsx
<ExtensionCleanup>
  <SafeHydration fallback={<LoadingSpinner />}>
    {/* Ваш контент */}
  </SafeHydration>
</ExtensionCleanup>
```

## Поддерживаемые атрибуты

Компонент автоматически удаляет следующие атрибуты:
- `bis_skin_checked` - Bitdefender
- `data-adblock*` - AdBlock
- `data-ublock-origin` - uBlock Origin
- `data-ghostery` - Ghostery
- `data-privacy-badger` - Privacy Badger
- `data-bitdefender` - Bitdefender
- `data-avast` - Avast
- `data-kaspersky` - Kaspersky
- И другие...

## Производительность

- Использует `requestAnimationFrame` для оптимизации
- Ограничивает количество очисток для React компонентов
- Автоматически останавливает наблюдение при размонтировании
- Минимальное влияние на производительность

## Отладка

Для включения отладочной информации:
1. Установите `debug={true}` в компоненте ExtensionCleanup
2. В правом верхнем углу появится индикатор активности
3. В консоли будут логи очистки

## Совместимость

- React 18+
- Next.js 13+ (App Router)
- Все современные браузеры
- Поддержка SSR/SSG

## Мониторинг

Компонент автоматически:
- Отслеживает изменения DOM
- Очищает атрибуты в реальном времени
- Логирует ошибки очистки
- Адаптируется к различным браузерным расширениям
